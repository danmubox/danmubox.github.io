var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var e=a[f];if(b.call(c,e,f,a))return{i:f,v:e}}return{i:-1,v:void 0}};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var f=b.length,e=a.length;c=Math.max(0,Math.min(c|0,b.length));for(var g=0;g<e&&c<f;)if(b[c++]!=a[g++])return!1;return g>=e}},"es6","es3");$jscomp.checkEs6ConformanceViaProxy=function(){try{var a={},b=Object.create(new $jscomp.global.Proxy(a,{get:function(c,d,f){return c==a&&"q"==d&&f==b}}));return!0===b.q}catch(c){return!1}};
$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS=!1;$jscomp.ES6_CONFORMANCE=$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS&&$jscomp.checkEs6ConformanceViaProxy();$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};
$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
$jscomp.polyfill("WeakMap",function(a){function b(){if(!a||!Object.seal)return!1;try{var b=Object.seal({}),c=Object.seal({}),d=new a([[b,2],[c,3]]);if(2!=d.get(b)||3!=d.get(c))return!1;d.delete(b);d.set(c,4);return!d.has(b)&&4==d.get(c)}catch(m){return!1}}function c(){}function d(a){var b=typeof a;return"object"===b&&null!==a||"function"===b}function f(a){if(!$jscomp.owns(a,g)){var b=new c;$jscomp.defineProperty(a,g,{value:b})}}function e(a){var b=Object[a];b&&(Object[a]=function(a){if(a instanceof
c)return a;f(a);return b(a)})}if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(a&&$jscomp.ES6_CONFORMANCE)return a}else if(b())return a;var g="$jscomp_hidden_"+Math.random();e("freeze");e("preventExtensions");e("seal");var k=0,h=function(a){this.id_=(k+=Math.random()+1).toString();if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};h.prototype.set=function(a,b){if(!d(a))throw Error("Invalid WeakMap key");f(a);if(!$jscomp.owns(a,g))throw Error("WeakMap key fail: "+
a);a[g][this.id_]=b;return this};h.prototype.get=function(a){return d(a)&&$jscomp.owns(a,g)?a[g][this.id_]:void 0};h.prototype.has=function(a){return d(a)&&$jscomp.owns(a,g)&&$jscomp.owns(a[g],this.id_)};h.prototype.delete=function(a){return d(a)&&$jscomp.owns(a,g)&&$jscomp.owns(a[g],this.id_)?delete a[g][this.id_]:!1};return h},"es6","es3");$jscomp.MapEntry=function(){};
$jscomp.polyfill("Map",function(a){function b(){if($jscomp.ASSUME_NO_NATIVE_MAP||!a||"function"!=typeof a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var b=Object.seal({x:4}),c=new a($jscomp.makeIterator([[b,"s"]]));if("s"!=c.get(b)||1!=c.size||c.get({x:4})||c.set({x:4},"t")!=c||2!=c.size)return!1;var d=c.entries(),e=d.next();if(e.done||e.value[0]!=b||"s"!=e.value[1])return!1;e=d.next();return e.done||4!=e.value[0].x||"t"!=e.value[1]||!d.next().done?!1:!0}catch(m){return!1}}
if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(a&&$jscomp.ES6_CONFORMANCE)return a}else if(b())return a;$jscomp.initSymbolIterator();var c=new WeakMap,d=function(a){this.data_={};this.head_=g();this.size=0;if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};d.prototype.set=function(a,b){a=0===a?0:a;var c=f(this,a);c.list||(c.list=this.data_[c.id]=[]);c.entry?c.entry.value=b:(c.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:a,
value:b},c.list.push(c.entry),this.head_.previous.next=c.entry,this.head_.previous=c.entry,this.size++);return this};d.prototype.delete=function(a){a=f(this,a);return a.entry&&a.list?(a.list.splice(a.index,1),a.list.length||delete this.data_[a.id],a.entry.previous.next=a.entry.next,a.entry.next.previous=a.entry.previous,a.entry.head=null,this.size--,!0):!1};d.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=g();this.size=0};d.prototype.has=function(a){return!!f(this,a).entry};
d.prototype.get=function(a){return(a=f(this,a).entry)&&a.value};d.prototype.entries=function(){return e(this,function(a){return[a.key,a.value]})};d.prototype.keys=function(){return e(this,function(a){return a.key})};d.prototype.values=function(){return e(this,function(a){return a.value})};d.prototype.forEach=function(a,b){for(var c=this.entries(),d;!(d=c.next()).done;)d=d.value,a.call(b,d[1],d[0],this)};d.prototype[Symbol.iterator]=d.prototype.entries;var f=function(a,b){var d=b&&typeof b;"object"==
d||"function"==d?c.has(b)?d=c.get(b):(d=""+ ++k,c.set(b,d)):d="p_"+b;var e=a.data_[d];if(e&&$jscomp.owns(a.data_,d))for(a=0;a<e.length;a++){var m=e[a];if(b!==b&&m.key!==m.key||b===m.key)return{id:d,list:e,index:a,entry:m}}return{id:d,list:e,index:-1,entry:void 0}},e=function(a,b){var c=a.head_;return $jscomp.iteratorPrototype(function(){if(c){for(;c.head!=a.head_;)c=c.previous;for(;c.next!=c.head;)return c=c.next,{done:!1,value:b(c)};c=null}return{done:!0,value:void 0}})},g=function(){var a={};return a.previous=
a.next=a.head=a},k=0;return d},"es6","es3");$jscomp.polyfill("Array.from",function(a){return a?a:function(a,c,d){c=null!=c?c:function(a){return a};var b=[],e="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if("function"==typeof e){a=e.call(a);for(var g=0;!(e=a.next()).done;)b.push(c.call(d,e.value,g++))}else for(e=a.length,g=0;g<e;g++)b.push(c.call(d,a[g],g));return b}},"es6","es3");
var Common=function(){var a="B KB MB GB TB PB EB ZB YB".split(" ");return{renderSize:function(b){if(null==b||""==b)return"0 Bytes";var c=parseFloat(b);b=Math.floor(Math.log(c)/Math.log(1024));c/=Math.pow(1024,b);c=c.toFixed(2);return c+a[b]},removePostfix:function(a){var b=a.lastIndexOf(".");0<b&&(a=a.substring(0,b));return a},initTooltip:function(){$('[data-toggle="tooltip"]').tooltip()},writeCookie:function(a,c){$.cookie(a,c,{expires:9999})},cookieIfPresent:function(a,c){(a=$.cookie(a))&&c(a)},
render:function(a,c){a.content||(a.content=$(a.name).html().trim(),Mustache.parse(a.content));return Mustache.render(a.content,c)},ts:function(){return Math.round((new Date).getTime()/1E3).toString()}}}();$(function(){$.cookie.json=!0;toastr.options.closeButton=!0;Common.initTooltip()});
var ChatServerArray=[{name:"bilibili",value:"chat.bilibili.com"},{name:"\u4f18\u9177",value:"service.danmu.youku.com"},{name:"\u7231\u5947\u827a",value:"cmts.iqiyi.com"},{name:"\u817e\u8baf",value:"mfm.video.qq.com"},{name:"\u7b2c\u4e00\u5f39",value:"api.diyidan.net"},{name:"\u52a8\u753b\u75af",value:"ani.gamer.com.tw"},{name:"AcFun",value:"danmu.aixifan.com"},{name:"\u641c\u72d0",value:"api.danmu.tv.sohu.com"}],ENUM_TASK_STATE={WAIT_PARSE:0,WAIT_HANDLE:1,HANDLEING:2,HANDLE_SUCCESS:3,HANDLE_FAIL:-1,
PARSE_FAIL:-2},TaskStateResolver={parse:function(a){if(a==ENUM_TASK_STATE.WAIT_PARSE)a="\u5f85\u89e3\u6790";else if(a==ENUM_TASK_STATE.WAIT_HANDLE)a="\u5f85\u5904\u7406";else if(a==ENUM_TASK_STATE.HANDLEING)a="\u5904\u7406\u4e2d";else if(a==ENUM_TASK_STATE.HANDLE_SUCCESS)a="\u5904\u7406\u5b8c\u6210";else if(a==ENUM_TASK_STATE.HANDLE_FAIL)a="\u5904\u7406\u5931\u8d25";else if(a==ENUM_TASK_STATE.PARSE_FAIL)a="\u89e3\u6790\u5931\u8d25";else throw Error("\u672a\u77e5\u7684\u4efb\u52a1\u72b6\u6001\uff1a"+
a);return a}},ItemOriginResolver={resolve:function(a){var b="\u672a\u77e5";if(void 0==a)b="-";else for(var c=$jscomp.makeIterator(ChatServerArray),d=c.next();!d.done;d=c.next())if(d=d.value,d.value==a){b=d.name;break}return b}},ToolbarTable=function(a){this.$table=$("#"+a+" .table");this.$table.bootstrapTable("refreshOptions",{locale:"zh-CN"});this.$add=$("#"+a+" .file-input");this.$remove=$("#"+a+" .btn-remove");this.$clear=$("#"+a+" .btn-clear");this.initToolbar()};
ToolbarTable.prototype.initToolbar=function(){var a=this;this.$add.on("change",function(b){a.resolve(b.target.files);a.$add.val(null)});this.$table.on("check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table",function(b){b=0==a.$table.bootstrapTable("getSelections").length;a.$remove.attr("disabled",b)});this.$table.on("reset-view.bs.table",function(){var b=0==a.getValidData().length;a.$clear.attr("disabled",b);if(a.onEmptyListener)a.onEmptyListener(b)});this.$clear.click(function(){return a.$table.bootstrapTable("removeAll")});
this.$remove.click(function(){for(var b=a.$table.bootstrapTable("getSelections"),c=0;c<b.length;c++)a.$table.bootstrapTable("removeByUniqueId",b[c].name);a.$remove.attr("disabled",!0)})};ToolbarTable.prototype.getValidData=function(){return this.$table.bootstrapTable("getData").filter(function(a){a=a.state;return a==ENUM_TASK_STATE.WAIT_HANDLE||a==ENUM_TASK_STATE.HANDLE_SUCCESS||a==ENUM_TASK_STATE.HANDLE_FAIL})};
ToolbarTable.prototype.addIfAbsent=function(a){if(null==this.$table.bootstrapTable("getRowByUniqueId",a.name)){var b=[];b.push(a);this.$table.bootstrapTable("append",b)}else toastr.warning("\u6587\u4ef6\uff1a"+a.name+"\uff0c\u5df2\u5728\u8868\u683c\u4e2d\uff01")};ToolbarTable.prototype.resolve=function(a){throw Error("this method has not been implemented.");};ToolbarTable.prototype.updateData=function(a){this.$table.bootstrapTable("updateByUniqueId",{id:a.name,row:a})};
var TableItem=function(a){this.file=a;this.name=Common.removePostfix(a.name);this.length=a.size;this.state=ENUM_TASK_STATE.WAIT_PARSE},ModalDrag=function(a){this.$modal=$("#modal-drag");this.initDrag(a)};
ModalDrag.prototype.initDrag=function(a){var b=this,c=this.$modal.find(".modal-content");this.enterH1=!1;var d=c.find("h1");d.on("dragenter",function(){b.enterH1=!0;return!1});d.on("dragleave",function(){return b.enterH1=!1});c.on("dragenter",function(){c.css("opacity",1);return!1});c.on("dragleave",function(){b.enterH1||c.css("opacity",.5);return!1});c.on("dragover",function(){return!1});c.on("drop",function(d){a(d.originalEvent.dataTransfer.files);b.$modal.modal("hide");b.enterH1=!1;c.css("opacity",
.5);return!1});$("body").on("dragenter",function(){b.$modal.modal("show");return!1});this.$modal.on("dragenter",function(){return!1});this.$modal.on("dragleave",function(){1!=parseInt(c.css("opacity"))&&b.$modal.modal("hide");return!1});this.$modal.on("dragover",function(){return!1});this.$modal.on("drop",function(){b.$modal.modal("hide");return!1})};
var DragTableHelper=function(){function a(a){return!a.find("span").hasClass("d-none")}return{fixTableHeight:function(a){var b=a.parents(".fixed-table-container");a.on("post-header.bs.table page-change.bs.table reset-view.bs.table",function(){b.height(a.height()-35)})},initExecute:function(a,c){function b(){g.attr("disabled",!1);e.addClass("d-none")}var f=$("#btn-execute"),e=f.find("span"),g=$("#form-"+a);f.click(function(){g.attr("disabled",!0);e.removeClass("d-none");c(b)});return f},bindToolbarTableAndExecute:function(a,
c){a.onEmptyListener=function(a){return c.attr("disabled",a)}},isExecuting:a,initModalDrag:function(b,c){new ModalDrag(function(d){a(b)?toastr.warning("\u6267\u884c\u4e2d\uff0c\u65e0\u6cd5\u6dfb\u52a0\u6587\u4ef6\uff01"):c(d)})}}}(),DanMuHandler=function(){var a={name:"#template-danmu"};return{resolveFiles:function(a,c,d){function b(a,b){var c=b.find("chatserver:first").text();b=b.find("d");a.origin=c;a.num=b.length;a.state=ENUM_TASK_STATE.WAIT_HANDLE}a=$jscomp.makeIterator(a);for(var e=a.next();!e.done;e=
a.next())e=e.value,"text/xml"!=e.type?toastr.error("\u6587\u4ef6\uff1a"+e.name+"\uff0c\u4e0d\u662f\u4e00\u4e2a\u5f39\u5e55\u6587\u4ef6\uff01"):(e=new TableItem(e),c(e),DanMuHandler.read(e,b,d))},read:function(a,c,d){var b=new FileReader;b.onload=function(){try{var b=$($.parseXML(this.result))}catch(g){console.error(g);toastr.error("\u6587\u4ef6\uff1a"+a.name+"\uff0c\u975e\u6807\u51c6\u5f39\u5e55XML\uff01");a.state=ENUM_TASK_STATE.PARSE_FAIL;d(a);return}c(a,b);d(a)};b.readAsText(a.file,"UTF-8")},parseDanMu:function(a,
c){var b=c.find("chatid:first").text();c=c.find("d").map(function(a,b){a=$(b);b=a.attr("p").split(",");return new DanMuItem(a.text().trim(),b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7])}).toArray();return new DanMu(a.origin,b,c)},render:function(b){return Common.render(a,b)}}}(),DanMuTable=function(){ToolbarTable.apply(this,arguments)};$jscomp.inherits(DanMuTable,ToolbarTable);
DanMuTable.prototype.resolve=function(a){var b=this.addIfAbsent.bind(this),c=this.updateData.bind(this);DanMuHandler.resolveFiles(a,b,c)};var DanMu=function(a,b,c){this.chatServer=a;this.chatId=b;this.items=c},DanMuItem=function(a,b,c,d,f,e,g,k,h){this.content=a;this.playTime=parseFloat(b);this.type=parseInt(c);this.size=parseInt(d);this.color=parseInt(f);this.createTime=e;this.pool=g;this.uid=k;this.historyId=h};
$jscomp.global.Object.defineProperties(DanMuItem,{defaultSize:{configurable:!0,enumerable:!0,get:function(){return 25}},defaultColor:{configurable:!0,enumerable:!0,get:function(){return 16777215}}});
var AssHelper=function(){function a(a,c,d,e,g,f,k){for(var m=0;m<a.length;m++){var p=a[m];if(null==p){b(a,c,d,m,e,g,f,k);break}else if(g.playTime-p.playTime>=e.fixedStayTime){b(a,c,d,m,e,g,f,k);break}}}function b(a,b,d,q,k,h,l,n){a[q]=h;a=new PosAssEffect(k.videoWidth/2,n==g.TOP?(q+1)*l:k.videoHeight-q*l);f(a,d,l,h.color);b.push(new AssEvent(0,e(h.playTime),e(c(h.playTime,k.fixedStayTime)),a,h.content))}function c(a,b){return(1E3*a+1E3*b)/1E3}function d(a,b,d,g,k,h,l){a[g]=h;a=l*(g+1);a=new MoveAssEffect(k.videoWidth+
h.content.length*l/2,a,-(h.content.length*l/2),a);f(a,d,l,h.color);b.push(new AssEvent(0,e(h.playTime),e(c(h.playTime,k.rollStayTime)),a,h.content))}function f(a,b,c,d){c!=b.fontSize&&(a.fontSize=c);c=AssHelper.rgb10ToBgr16(d);c!=b.fontColor&&(a.fontColor=c)}function e(a){var b=parseInt(a/3600);10>b&&(b="0"+b);var c=parseInt((a-3600*b)/60);10>c&&(c="0"+c);var d=parseInt((a-3600*b)%60);10>d&&(d="0"+d);a=parseInt((1E3*a-1E3*parseInt(a))/10);0==a?a="00":10>a&&(a="0"+a);return b+":"+c+":"+d+"."+a}var g=
{ROLL:0,TOP:1,BOTTOM:2},k=/\\pos\(([\d.]+),[ ]?([\d.]+)\)/,h=/\\move\(([\d.]+),[ ]?([\d.]+),[ ]?([\d.-]+),[ ]?([\d.]+)\)/,l=/\\c&H(\w+)/,r=/\\fs(\d+)/,n=/\{[^\}]+\}(.*)/;return{addIfPass:function(b,e,f,h,k){var m=AssHelper.scaleFontSize(b.size,h.fontScale);var l=g.ROLL;4==b.type?l=g.BOTTOM:5==b.type&&(l=g.TOP);if(l==g.TOP)a(f.tops,e,k,h,b,m,l);else if(l==g.BOTTOM)a(f.bottoms,e,k,h,b,m,l);else for(f=f.rolls,l=0;l<f.length;l++){var p=f[l];if(p){var q=p.playTime,n=AssHelper.scaleFontSize(p.size,h.fontScale);
p=p.content.length*n;p=c(q,parseInt(h.rollStayTime*p/(h.videoWidth+p)));q=c(q,h.rollStayTime);n=c(b.playTime,parseInt(h.rollStayTime*h.videoWidth/(h.videoWidth+b.content.length*m)));if(b.playTime>=p&&n>=q){d(f,e,k,l,h,b,m);break}}else{d(f,e,k,l,h,b,m);break}}},rgb10ToBgr16:function(a){a=parseInt(a).toString(16).toUpperCase();if(6!=a.length)return"FFFFFF";a=a.split("");return""+(a[4]+a[5])+(a[2]+a[3])+(a[0]+a[1])},bgr16ToRgb10:function(a){try{var b=a.split("");var c=parseInt(""+(b[4]+b[5])+(b[2]+b[3])+
(b[0]+b[1]),16)}catch(q){console.error(q),c=DanMuItem.defaultColor}return c},scaleFontSize:function(a,b){return parseInt(a*b*100/100)},date24H2second:function(a){var b=a.split(":");a=parseInt(3600*b[0]);var c=parseInt(60*b[1]);b=b[2].split(".");var d=parseInt(b[0]);return parseFloat(a+c+d+"."+(b[1]+"0"))},calculateType:function(a,b){b=b.effect;return b instanceof PosAssEffect?b.y>a.script.playResY/2?4:5:1},getScriptField:function(a,b){b+=": ";a=$jscomp.makeIterator(a);for(var c=a.next();!c.done;c=
a.next()){c=c.value;if(0==c.indexOf(b))return c.substring(b.length);if(0==c.indexOf("[Events]"))break}},parseText:function(a){return a.match(n)[1]},parseEffect:function(a){if(a.startsWith("{\\pos")){var b=a.match(k);b=new PosAssEffect(b[1],b[2])}else b=a.match(h),b=new MoveAssEffect(b[1],b[2],b[3],b[4]);var c=a.match(l);c&&(b.fontColor=c[1]);if(a=a.match(r))b.fontSize=parseInt(a[1]);return b}}}(),AssHandler=function(){var a={name:"#template-ass"};return{resolveFiles:function(a,c,d){function b(a){var b=
a.name;"ass"!=b.substring(b.lastIndexOf(".")+1).toLowerCase()?toastr.error("\u6587\u4ef6\uff1a"+b+"\uff0c\u4e0d\u662f\u4e00\u4e2a\u5b57\u5e55\u6587\u4ef6\uff01"):(a=new TableItem(a),c(a),AssHandler.read(a,function(a,b){var c=AssHelper.getScriptField(b,"ChatServer");b=b.filter(function(a){return 0==a.indexOf("Dialogue: ")});a.origin=c;a.num=b.length;a.state=ENUM_TASK_STATE.WAIT_HANDLE},d))}a=$jscomp.makeIterator(a);for(var e=a.next();!e.done;e=a.next())b(e.value,c,d)},read:function(a,c,d){var b=new FileReader;
b.onload=function(){var b=this.result.split(/[\r]?\n/);c(a,b);d(a)};b.readAsText(a.file,"UTF-8")},parseAss:function(a,c){a=AssHelper.getScriptField(c,"Title");var b=AssHelper.getScriptField(c,"ChatServer"),f=AssHelper.getScriptField(c,"ChatId"),e=AssHelper.getScriptField(c,"PlayResX"),g=AssHelper.getScriptField(c,"PlayResY");a=new AssScript(a,b,f,e,g);b=AssHelper.getScriptField(c,"Style").split(",");b=new AssStyle(b[1],b[2],b[3].substring(4),b[3].substring(2,4),"1"==b[7]);c=c.filter(function(a){return 0==
a.indexOf("Dialogue: ")}).map(function(a){var b=a.substring(10);a=b.split(",",9);var c=a.map(function(a){return a.length}).reduce(function(a,b){return a+b})+9;b=b.substring(c);try{var d=AssHelper.parseEffect(b)}catch(m){console.error(m),d=new MoveAssEffect(0,0,0,0)}try{var e=AssHelper.parseText(b)}catch(m){return console.error("\u5185\u5bb9\u89e3\u6790\u5931\u8d25\uff1a"+b),console.error(m),null}return new AssEvent(a[0],a[1],a[2],d,e)}).filter(function(a){return null!=a});return new Ass(a,b,c)},render:function(b){return Common.render(a,
b)}}}(),AssTable=function(){ToolbarTable.apply(this,arguments)};$jscomp.inherits(AssTable,ToolbarTable);AssTable.prototype.resolve=function(a){var b=this.addIfAbsent.bind(this),c=this.updateData.bind(this);AssHandler.resolveFiles(a,b,c)};
var Ass=function(a,b,c){this.script=a;this.style=b;this.events=c},AssScript=function(a,b,c,d,f){this.title=a;this.chatServer=b;this.chatId=c;this.playResX=d;this.playResY=f},AssStyle=function(a,b,c,d,f){this.name="DanMu";this.fontName=a;this.fontSize=b;this.fontColor=c;this.alpha=d;this.bold=f},AssEffect=function(){};AssEffect.prototype.number2FloatString=function(a){a=a.toString();-1==a.indexOf(".")&&(a+=".0");return a};
var PosAssEffect=function(a,b){AssEffect.call(this);a=this.number2FloatString(a);var c=this.number2FloatString(b);this.value="pos("+a+","+c+")";this.y=b};$jscomp.inherits(PosAssEffect,AssEffect);var MoveAssEffect=function(a,b,c,d){AssEffect.call(this);a=this.number2FloatString(a);b=this.number2FloatString(b);c=this.number2FloatString(c);d=this.number2FloatString(d);this.value="move("+a+","+b+","+c+","+d+")"};$jscomp.inherits(MoveAssEffect,AssEffect);
var AssEvent=function(a,b,c,d,f){this.layer=a;this.start=b;this.end=c;this.effect=d;this.text=f},ENUM_OUTPUT_TYPE={PACKAGE:0,EACH:1},ConvertHelper=function(){function a(b,c,d,f,e,g,k){g(c[b],function(h,l){h.state=ENUM_TASK_STATE.HANDLEING;f(h);var r=ENUM_TASK_STATE.HANDLE_SUCCESS;try{k(h,l)}catch(n){r=ENUM_TASK_STATE.HANDLE_FAIL,console.error(n),toastr.error(h.name+"\uff0c\u8f6c\u6362\u5931\u8d25\uff01")}h.state=r;f(h);b++;b==c.length?d.zip?(toastr.info("\u6b63\u5728\u6253\u5305\uff0c\u8bf7\u7a0d\u540e..."),
d.zip.generateAsync({type:"blob"}).then(function(a){toastr.success("\u6253\u5305\u5b8c\u6210\uff0c\u5373\u5c06\u5f00\u59cb\u4e0b\u8f7d\uff01");var b=Common.ts();saveAs(a,"[\u5f39\u5e55\u5305]["+d.name+"]("+b+").zip");e()})):e():a(b,c,d,f,e,g,k)})}return{convert:function(b,c,d,f,e,g){c.outputType==ENUM_OUTPUT_TYPE.PACKAGE&&1<b.length&&(c.zip=new JSZip);toastr.info("\u8f6c\u6362\u8fdb\u884c\u4e2d\uff0c\u8bf7\u7a0d\u5019...");a(0,b,c,d,f,e,g)},save:function(a,c,d){a.zip?a.zip.file(c,d):(a=new Blob([d],
{type:"text/plain;charset=utf-8"}),saveAs(a,c))}}}(),fontDatas="\u5fae\u8f6f\u96c5\u9ed1 \u5b8b\u4f53 \u9ed1\u4f53 \u5fae\u8f6f\u6b63\u9ed1\u4f53 \u6977\u4f53 \u65b0\u5b8b\u4f53 \u4eff\u5b8b \u82f9\u65b9 \u534e\u6587\u9ed1\u4f53 \u534e\u6587\u6977\u4f53 \u534e\u6587\u5b8b\u4f53 \u534e\u6587\u4eff\u5b8b \u534e\u6587\u4e2d\u5b8b \u534e\u6587\u7425\u73c0 \u534e\u6587\u65b0\u9b4f \u534e\u6587\u96b6\u4e66 \u534e\u6587\u884c\u6977 \u534e\u6587\u7ec6\u9ed1 \u534e\u6587\u4eff\u5b8b \u601d\u6e90\u9ed1\u4f53 \u5e7c\u5706 \u96b6\u4e66 \u601d\u6e90\u5b8b\u4f53 \u6587\u6cc9\u9a7f\u5fae\u7c73\u9ed1 \u65b9\u6b63\u7c97\u96c5\u5b8b\u7b80\u4f53".split(" "),
Xml2AssOption=function(a,b,c,d,f,e,g,k,h){this.videoWidth=a;this.videoHeight=b;this.fontFamily=c;this.bold=d;this.fontScale=f;this.alpha=e;this.rangeScale=g;this.rollStayTime=k;this.fixedStayTime=h;this.name="ass"},Xml2AssConverter=function(){function a(a,b){var c=new Map;a.forEach(function(a){a=a[b];c.set(a,(c.get(a)||0)+1)});return Array.from(c).sort(function(a,b){return b[1]-a[1]})[0][0]}var b=function(a){this.rolls=Array(a);this.tops=Array(a);this.bottoms=Array(a)};return{convert:function(c,d,
f,e){ConvertHelper.convert(c,d,f,e,function(a,b){DanMuHandler.read(a,b,f)},function(c,e){var f=DanMuHandler.parseDanMu(c,e);e=new AssScript(c.name,f.chatServer,f.chatId,d.videoWidth,d.videoHeight);var g=parseInt(255*(1-d.alpha)).toString(16),k=a(f.items,"size"),n=a(f.items,"color");g=new AssStyle(d.fontFamily,AssHelper.scaleFontSize(k,d.fontScale),AssHelper.rgb10ToBgr16(n),g,d.bold);k=parseInt(d.videoHeight/g.fontSize*d.rangeScale);f=f.items;k=new b(k);n=[];f.sort(function(a,b){return a.playTime-
b.playTime});for(var m=0;m<f.length;m++)AssHelper.addIfPass(f[m],n,k,d,g);e=new Ass(e,g,n);e=AssHandler.render(e);ConvertHelper.save(d,c.name+".ass",e)})}}}();
$(function(){function a(){var a=e.find(":selected").text(),b=k.val(),c=h.val(),d=g.is(":checked")?"bold":"normal";b=parseInt(b/100*DanMuItem.defaultSize);m.css("font-family",a);m.css("font-size",b+"pt");m.css("opacity",c/100);m.css("font-weight",d)}function b(b,c){var d=b.parent().find("d");b.bind("input propertychange",function(){d.text(b.val());c&&a()})}var c=$("#accordion-xml2ass"),d=c.find(".video-width"),f=c.find(".video-height"),e=c.find("select.font"),g=c.find("input.font-bold"),k=c.find(".font-scale"),
h=c.find(".font-opacity"),l=c.find(".range-scale"),r=c.find(".roll-stay"),n=c.find(".fixed-stay"),m=c.find(".font-example"),p=new DanMuTable("accordion-xml2ass"),t=p.updateData.bind(p);c.data("module",{table:p,execute:function(a,b){var c=new Xml2AssOption(parseInt(d.val()),parseInt(f.val()),e.find(":selected").val(),g.is(":checked"),k.val()/100,h.val()/100,l.val()/100,parseInt(r.val()),parseInt(n.val()));Common.writeCookie("convert_xml2ass",c);var m=p.getValidData();c.outputType=a;Xml2AssConverter.convert(m,
c,t,b)}});e.change(function(){return a()});g.change(function(){return a()});b(k,!0);b(h,!0);b(l,!1);b(r,!1);b(n,!1);fontDatas.forEach(function(a){return e.append('<option value="'+a+'">'+a+"</option>")});Common.cookieIfPresent("convert_xml2ass",function(a){d.val(a.videoWidth);f.val(a.videoHeight);e.find("option[value='"+a.fontFamily+"']").attr("selected",!0);g.attr("checked",a.bold);k.val(100*a.fontScale);h.val(100*a.alpha);l.val(100*a.rangeScale);r.val(a.rollStayTime);n.val(a.fixedStayTime);$([k[0],
h[0],l[0],r[0],n[0]]).trigger("input")});a()});
var Ass2XmlOption=function(a,b,c,d,f,e,g){this.chatServer=a;this.chatIdStrategy=b;this.fixedChatId=c;this.fillCreateTime=d;this.fillUid=f;this.fillHistoryId=e;this.outputType=g;this.name="xml"},Ass2XmlConverter=function(){return{convert:function(a,b,c,d){ConvertHelper.convert(a,b,c,d,function(a,b){AssHandler.read(a,b,c)},function(a,c){var d=AssHandler.parseAss(a,c);c=d.script.chatServer;c||(c=b.chatServer);var e=d.script.chatId;e||(e=1==b.chatIdStrategy?b.fixedChatId?b.fixedChatId:0:parseInt(99E5*
Math.random()+1E5,10));var f=d.events.map(function(a){var c=AssHelper.date24H2second(a.start),e=AssHelper.calculateType(d,a),f=d.style.fontSize;a.effect.fontSize&&(f=a.effect.fontSize);var g=a.effect.fontColor?AssHelper.bgr16ToRgb10(a.effect.fontColor):AssHelper.bgr16ToRgb10(d.style.fontColor);var h=0;b.fillCreateTime&&(h=Date.parse(new Date)/1E3-parseInt(604800*Math.random()+1,10));var l=0;if(b.fillUid)for(l="",i=0;8>i;i++)l+="0123456789abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(36*Math.random()));
var k=0;if(b.fillHistoryId){k=""+parseInt(9*Math.random()+1,10);for(i=1;15>i;i++)k+="0123456789".charAt(Math.floor(10*Math.random()));k=parseFloat(k)}return new DanMuItem(a.text,c,e,f,g,h,0,l,k)});c=new DanMu(c,e,f);c=DanMuHandler.render(c);ConvertHelper.save(b,a.name+".xml",c)})}}}();
$(function(){var a=$("#accordion-ass2xml"),b=a.find("select.danmu-server"),c=a.find("input.fixed-danmu-id"),d=a.find("input.fill-create-time"),f=a.find("input.fill-uid"),e=a.find("input.fill-history-id"),g=new AssTable("accordion-ass2xml"),k=g.updateData.bind(g);a.data("module",{table:g,execute:function(a,h){var l=new Ass2XmlOption(b.find(":selected").val(),$('input:radio[name="danMuId"]:checked').val(),parseInt(c.val()),d.is(":checked"),f.is(":checked"),e.is(":checked"));Common.writeCookie("convert_ass2xml",
l);var m=g.getValidData();l.outputType=a;Ass2XmlConverter.convert(m,l,k,h)}});ChatServerArray.forEach(function(a){return b.append('<option value="'+a.value+'">'+a.name+"</option>")});var h=a.find("input.fixed-danmu-id");$("input[name='danMuId']").click(function(a){a="rdo-fixed"!=$("input[name='danMuId']:checked").attr("id");h.attr("disabled",a)});Common.cookieIfPresent("convert_ass2xml",function(a){b.find("option[value='"+a.chatServer+"']").attr("selected",!0);$("input:radio[name=danMuId][value='"+
a.chatIdStrategy+"']").click();c.val(a.fixedChatId);d.attr("checked",a.fillCreateTime);f.attr("checked",a.fillUid);e.attr("checked",a.fillHistoryId)})});
$(function(){function a(){return $(".tab-pane.active div").first().data("module")}var b=$("#tab-convert>li>a"),c=DragTableHelper.initExecute("convert",function(c){b.addClass("disabled");var d=$('input:radio[name="outputType"]:checked').val();Common.writeCookie("convert",{outputType:d});a().execute(d,function(){b.removeClass("disabled");c()})});DragTableHelper.initModalDrag(c,function(b){return a().table.resolve(b)});b.each(function(a,b){var d=$(b);d.on("show.bs.tab",function(a){DragTableHelper.isExecuting(c)?
a.preventDefault():(a=d.attr("aria-controls"),a=0==$("#accordion-"+a).data("module").table.getValidData().length,c.attr("disabled",a))})});$(".tab-pane>div").each(function(a,b){a=$(b).data("module");DragTableHelper.bindToolbarTableAndExecute(a.table,c)});Common.cookieIfPresent("convert",function(a){$("input:radio[name=outputType][value='"+a.outputType+"']").attr("checked",!0)})});
